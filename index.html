<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1">
    <title>CHRONOS Earth Control System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@300;400;700;900&display=swap');

```
    :root {
        --neon-blue: #00FFFF !important;
        --neon-cyan: #25E1ED !important;
        --electric-blue: #0080FF !important;
        --temporal-gold: #FFD700 !important;
        --quantum-purple: #BD00FF !important;
        --deep-black: #000000 !important;
        --charcoal: #111111 !important;
        --radiation-green: #00FF9F !important;
        --panel-bg: rgba(0, 0, 0, 0.85) !important;
    }

    * {
        margin: 0 !important;
        padding: 0 !important;
        box-sizing: border-box !important;
    }

    body {
        background: #000000 !important;
        font-family: 'Orbitron', monospace !important;
        overflow: hidden !important;
        position: fixed !important;
        width: 100% !important;
        height: 100% !important;
        color: var(--neon-blue) !important;
        touch-action: none !important;
    }

    #globe-container {
        width: 100% !important;
        height: 100% !important;
        touch-action: none !important;
        position: relative !important;
    }

    .loading-screen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        background: var(--deep-black) !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        z-index: 1000 !important;
        transition: opacity 0.8s ease-out !important;
    }

    .loading-spinner {
        width: 60px !important;
        height: 60px !important;
        border: 3px solid transparent !important;
        border-top: 3px solid var(--neon-blue) !important;
        border-radius: 50% !important;
        animation: spin 1.5s linear infinite !important;
        margin-bottom: 1.5rem !important;
        box-shadow: 0 0 20px var(--neon-blue) !important;
    }

    @keyframes spin {
        0% { transform: rotate(0deg) !important; }
        100% { transform: rotate(360deg) !important; }
    }

    .system-title {
        color: var(--neon-blue) !important;
        font-size: 3rem !important;
        font-weight: 900 !important;
        text-align: center !important;
        letter-spacing: 4px !important;
        text-shadow: 0 0 20px var(--neon-blue) !important;
        animation: pulse-title 3s ease-in-out infinite !important;
        margin-bottom: 1rem !important;
    }

    @keyframes pulse-title {
        0%, 100% { 
            opacity: 1 !important; 
            text-shadow: 0 0 20px var(--neon-blue) !important;
        }
        50% { 
            opacity: 0.7 !important; 
            text-shadow: 0 0 40px var(--neon-cyan) !important;
        }
    }

    .loading-text {
        color: var(--neon-cyan) !important;
        font-size: 1rem !important;
        font-weight: 300 !important;
        text-align: center !important;
    }

    /* Top Header - Minimal */
    .top-header {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        padding: 1rem !important;
        z-index: 100 !important;
        text-align: center !important;
        pointer-events: none !important;
    }

    .chronos-title {
        color: var(--neon-blue) !important;
        font-size: 2.5rem !important;
        font-weight: 900 !important;
        letter-spacing: 3px !important;
        text-shadow: 0 0 20px var(--neon-blue) !important;
        animation: title-glow 4s ease-in-out infinite !important;
    }

    @keyframes title-glow {
        0%, 100% { text-shadow: 0 0 20px var(--neon-blue) !important; }
        50% { text-shadow: 0 0 40px var(--neon-cyan), 0 0 60px var(--neon-blue) !important; }
    }

    /* Side Panels - Not blocking globe */
    .left-panel {
        position: absolute !important;
        top: 120px !important;
        left: 10px !important;
        width: 200px !important;
        z-index: 100 !important;
        pointer-events: auto !important;
    }

    .right-panel {
        position: absolute !important;
        top: 120px !important;
        right: 10px !important;
        width: 200px !important;
        z-index: 100 !important;
        pointer-events: auto !important;
    }

    .status-card {
        background: var(--panel-bg) !important;
        border: 1px solid var(--neon-blue) !important;
        border-radius: 8px !important;
        padding: 12px !important;
        margin-bottom: 10px !important;
        backdrop-filter: blur(10px) !important;
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.3) !important;
    }

    .card-header {
        display: flex !important;
        align-items: center !important;
        margin-bottom: 8px !important;
    }

    .status-dot {
        width: 8px !important;
        height: 8px !important;
        border-radius: 50% !important;
        background: var(--neon-blue) !important;
        box-shadow: 0 0 10px var(--neon-blue) !important;
        animation: pulse-dot 2s ease-in-out infinite !important;
        margin-right: 8px !important;
    }

    @keyframes pulse-dot {
        0%, 100% { opacity: 1 !important; }
        50% { opacity: 0.5 !important; }
    }

    .card-title {
        color: var(--neon-cyan) !important;
        font-size: 0.7rem !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: 1px !important;
    }

    .card-value {
        color: var(--neon-blue) !important;
        font-size: 1.2rem !important;
        font-weight: 700 !important;
        margin-bottom: 4px !important;
    }

    .card-label {
        color: rgba(255, 255, 255, 0.7) !important;
        font-size: 0.6rem !important;
        font-weight: 300 !important;
    }

    /* Bottom Controls */
    .bottom-controls {
        position: absolute !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        padding: 15px !important;
        text-align: center !important;
        background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%) !important;
        z-index: 100 !important;
        pointer-events: none !important;
    }

    .instructions {
        color: rgba(255, 255, 255, 0.8) !important;
        font-size: 0.8rem !important;
        font-weight: 300 !important;
    }

    /* TMZ Tooltip - Appears on tap, doesn't block globe */
    .tmz-popup {
        position: absolute !important;
        background: var(--panel-bg) !important;
        border: 1px solid var(--neon-blue) !important;
        border-radius: 8px !important;
        padding: 15px !important;
        color: white !important;
        font-size: 0.8rem !important;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.5) !important;
        backdrop-filter: blur(15px) !important;
        max-width: 280px !important;
        z-index: 200 !important;
        transform: translate(-50%, -100%) !important;
        margin-top: -10px !important;
        opacity: 0 !important;
        visibility: hidden !important;
        transition: all 0.3s ease !important;
        pointer-events: auto !important;
    }

    .tmz-popup.visible {
        opacity: 1 !important;
        visibility: visible !important;
    }

    .tmz-popup h4 {
        color: var(--neon-cyan) !important;
        margin-bottom: 8px !important;
        font-size: 0.9rem !important;
        font-weight: 700 !important;
    }

    .tmz-popup .close-btn {
        position: absolute !important;
        top: 5px !important;
        right: 10px !important;
        background: none !important;
        border: none !important;
        color: var(--neon-blue) !important;
        font-size: 1.2rem !important;
        cursor: pointer !important;
        padding: 0 !important;
        line-height: 1 !important;
    }

    .tmz-info-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 8px !important;
        margin-top: 8px !important;
    }

    .info-item {
        display: flex !important;
        flex-direction: column !important;
    }

    .info-label {
        font-size: 0.6rem !important;
        color: rgba(255, 255, 255, 0.6) !important;
        text-transform: uppercase !important;
        margin-bottom: 2px !important;
    }

    .info-value {
        font-size: 0.8rem !important;
        color: var(--neon-blue) !important;
        font-weight: 600 !important;
    }

    /* Network indicator */
    .network-status {
        display: flex !important;
        align-items: center !important;
        gap: 5px !important;
        margin-top: 5px !important;
    }

    .network-indicator {
        width: 5px !important;
        height: 5px !important;
        border-radius: 50% !important;
        background: var(--radiation-green) !important;
        box-shadow: 0 0 5px var(--radiation-green) !important;
        animation: pulse-network 1.5s ease-in-out infinite !important;
    }

    @keyframes pulse-network {
        0%, 100% { opacity: 1 !important; }
        50% { opacity: 0.4 !important; }
    }

    .network-text {
        color: var(--radiation-green) !important;
        font-size: 0.6rem !important;
        font-weight: 600 !important;
    }

    /* Error screen */
    .error-screen {
        text-align: center !important;
        color: #ff4444 !important;
    }

    .retry-btn {
        margin-top: 1.5rem !important;
        padding: 0.8rem 1.5rem !important;
        background: var(--neon-blue) !important;
        color: var(--deep-black) !important;
        border: none !important;
        border-radius: 6px !important;
        cursor: pointer !important;
        font-family: 'Orbitron', monospace !important;
        font-weight: 700 !important;
        text-transform: uppercase !important;
        letter-spacing: 1px !important;
        box-shadow: 0 0 20px rgba(0, 255, 255, 0.5) !important;
        transition: all 0.3s ease !important;
    }

    .retry-btn:hover {
        background: var(--neon-cyan) !important;
        box-shadow: 0 0 30px rgba(37, 225, 237, 0.7) !important;
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .chronos-title {
            font-size: 2rem !important;
            letter-spacing: 2px !important;
        }
        
        .left-panel, .right-panel {
            width: 180px !important;
        }
        
        .status-card {
            padding: 10px !important;
        }
        
        .card-title {
            font-size: 0.65rem !important;
        }
        
        .card-value {
            font-size: 1rem !important;
        }
        
        .tmz-popup {
            max-width: 250px !important;
            padding: 12px !important;
        }
    }

    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
        * {
            animation: none !important;
            transition: none !important;
        }
    }
</style>
```

</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <h1 class="system-title">CHRONOS</h1>
        <p class="loading-text">Initializing Temporal Control Matrix...</p>
        <div style="margin-top: 2rem !important; font-size: 0.8rem !important; color: rgba(37, 225, 237, 0.7) !important;">
            <div>▶ Loading TMZ Network...</div>
            <div>▶ Establishing Quantum Links...</div>
            <div>▶ Calibrating Reality Anchors...</div>
        </div>
    </div>

```
<div id="globe-container"></div>

<!-- Top Header -->
<div class="top-header">
    <h1 class="chronos-title">CHRONOS</h1>
</div>

<!-- Left Panel -->
<div class="left-panel">
    <div class="status-card">
        <div class="card-header">
            <div class="status-dot"></div>
            <h3 class="card-title">System Status</h3>
        </div>
        <div class="card-value" id="utc-time">--:--:--</div>
        <div class="card-label">Universal Control</div>
        <div class="network-status">
            <div class="network-indicator"></div>
            <span class="network-text">ONLINE</span>
        </div>
    </div>
    
    <div class="status-card">
        <div class="card-header">
            <div class="status-dot"></div>
            <h3 class="card-title">Active TMZs</h3>
        </div>
        <div class="card-value" id="tmz-count">8</div>
        <div class="card-label">Monitored Zones</div>
        <div class="network-status">
            <div class="network-indicator"></div>
            <span class="network-text">SYNCED</span>
        </div>
    </div>
</div>

<!-- Right Panel -->
<div class="right-panel">
    <div class="status-card">
        <div class="card-header">
            <div class="status-dot"></div>
            <h3 class="card-title">Chrono-Rail</h3>
        </div>
        <div class="card-value" id="rail-connections">28</div>
        <div class="card-label">Active Links</div>
        <div class="network-status">
            <div class="network-indicator"></div>
            <span class="network-text">OPERATIONAL</span>
        </div>
    </div>

    <div class="status-card">
        <div class="card-header">
            <div class="status-dot"></div>
            <h3 class="card-title">Quantum Grid</h3>
        </div>
        <div class="card-value" id="quantum-status">100%</div>
        <div class="card-label">Efficiency</div>
        <div class="network-status">
            <div class="network-indicator"></div>
            <span class="network-text">STABLE</span>
        </div>
    </div>
</div>

<!-- Bottom Controls -->
<div class="bottom-controls">
    <div class="instructions">
        <span style="color: var(--neon-cyan) !important;">DRAG</span> to rotate • 
        <span style="color: var(--neon-cyan) !important;">PINCH</span> to zoom • 
        <span style="color: var(--neon-cyan) !important;">TAP</span> TMZs for info
    </div>
</div>

<!-- TMZ Popup -->
<div id="tmz-popup" class="tmz-popup">
    <button class="close-btn" onclick="this.parentElement.classList.remove('visible')">&times;</button>
    <h4 id="popup-title">TMZ Information</h4>
    <p id="popup-description" style="margin-bottom: 8px !important; font-size: 0.7rem !important; color: rgba(255,255,255,0.8) !important;"></p>
    <div class="tmz-info-grid">
        <div class="info-item">
            <span class="info-label">Population</span>
            <span class="info-value" id="popup-population">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Status</span>
            <span class="info-value" id="popup-status">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">Tier Level</span>
            <span class="info-value" id="popup-tier">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">UTC Offset</span>
            <span class="info-value" id="popup-offset">--</span>
        </div>
    </div>
</div>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" 
        onerror="this.onerror=null;this.src='https://unpkg.com/three@0.150.0/build/three.min.js'"></script>
<script src="https://cdn.jsdelivr.net/npm/globe.gl@2.26.0/dist/globe.gl.min.js" 
        onerror="this.onerror=null;this.src='https://unpkg.com/globe.gl@2.26.0/dist/globe.gl.min.js'"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js" 
        onerror="this.onerror=null;this.src='https://unpkg.com/hammerjs@2.0.8/hammer.min.js'"></script>

<script>
    class CHRONOSEarth {
        constructor() {
            this.globe = null;
            this.scene = null;
            this.camera = null;
            this.renderer = null;
            this.isGlobeGlAvailable = false;
            this.currentPopup = null;
            this.popupTimeout = null;
            
            // CHRONOS TMZ Data
            this.tmzData = [
                {
                    name: "Boston Prime",
                    lat: 42.3601, lng: -71.0589,
                    population: "4.7M", status: "COMMAND", tier: "ALPHA",
                    offset: "-05:00", 
                    description: "Primary CHRONOS Command Hub. Master Clock location."
                },
                {
                    name: "Neo Beijing",
                    lat: 39.9042, lng: 116.4074,
                    population: "8.2M", status: "OPERATIONAL", tier: "ALPHA",
                    offset: "+08:00",
                    description: "Asian Command Center with temporal acceleration zones."
                },
                {
                    name: "London Chronos",
                    lat: 51.5074, lng: -0.1278,
                    population: "3.1M", status: "OPERATIONAL", tier: "ALPHA", 
                    offset: "+00:00",
                    description: "European Hub with underwater Chrono-Rail to Africa."
                },
                {
                    name: "Tokyo Temporal",
                    lat: 35.6762, lng: 139.6503,
                    population: "6.8M", status: "OPERATIONAL", tier: "ALPHA",
                    offset: "+09:00",
                    description: "Pacific Command with oceanic TMZ platforms."
                },
                {
                    name: "Sydney Nexus",
                    lat: -33.8688, lng: 151.2093,
                    population: "2.4M", status: "OPERATIONAL", tier: "BETA",
                    offset: "+11:00",
                    description: "Oceanic Hub with experimental TMZ designs."
                },
                {
                    name: "Cairo Quantum",
                    lat: 30.0444, lng: 31.2357,
                    population: "1.8M", status: "OPERATIONAL", tier: "BETA",
                    offset: "+02:00",
                    description: "African Center with desert climate optimization."
                },
                {
                    name: "São Paulo Grid",
                    lat: -23.5505, lng: -46.6333,
                    population: "3.2M", status: "OPERATIONAL", tier: "BETA",
                    offset: "-03:00",
                    description: "South American Hub with weather control systems."
                },
                {
                    name: "Mumbai Temporal",
                    lat: 19.0760, lng: 72.8777,
                    population: "5.1M", status: "OPERATIONAL", tier: "BETA",
                    offset: "+05:30",
                    description: "South Asian Center with monsoon temporal control."
                }
            ];

            this.railConnections = [
                ["Boston Prime", "London Chronos"],
                ["London Chronos", "Neo Beijing"],
                ["Neo Beijing", "Tokyo Temporal"],
                ["Tokyo Temporal", "Sydney Nexus"],
                ["London Chronos", "Cairo Quantum"],
                ["Cairo Quantum", "Mumbai Temporal"],
                ["Mumbai Temporal", "Neo Beijing"],
                ["Boston Prime", "São Paulo Grid"],
                ["São Paulo Grid", "London Chronos"],
                ["Sydney Nexus", "Tokyo Temporal"],
                ["Tokyo Temporal", "Boston Prime"],
                ["Sydney Nexus", "São Paulo Grid"],
                ["Neo Beijing", "Mumbai Temporal"],
                ["Cairo Quantum", "São Paulo Grid"]
            ];
            
            this.waitForLibraries().then(() => {
                this.init();
            }).catch(error => {
                this.initFallback();
            });
        }

        async waitForLibraries() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const checkLibraries = () => {
                    attempts++;
                    
                    if (typeof THREE !== 'undefined') {
                        this.isGlobeGlAvailable = typeof Globe !== 'undefined';
                        resolve();
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        reject(new Error('Libraries failed to load'));
                        return;
                    }
                    
                    setTimeout(checkLibraries, 100);
                };
                
                checkLibraries();
            });
        }

        async init() {
            try {
                if (this.isGlobeGlAvailable) {
                    this.setupGlobeGL();
                } else {
                    this.setupThreeJSFallback();
                }
                
                this.setupControls();
                this.startTimeUpdates();
                this.updateStats();
                
                setTimeout(() => {
                    this.hideLoading();
                }, 2500);
                
            } catch (error) {
                console.error('Failed to initialize:', error);
                this.initFallback();
            }
        }

        setupGlobeGL() {
            const container = document.getElementById('globe-container');
            
            this.globe = Globe()(container)
                .globeImageUrl(this.generateBlackEarthTexture())
                .bumpImageUrl(null)
                .backgroundImageUrl(this.generateStarField())
                .showGraticules(false)
                .showAtmosphere(true)
                .atmosphereColor('#00FFFF')
                .atmosphereAltitude(0.15)
                .width(window.innerWidth)
                .height(window.innerHeight);

            const camera = this.globe.camera();
            camera.position.z = 300;

            this.globe.controls().autoRotate = true;
            this.globe.controls().autoRotateSpeed = 0.4;
            this.globe.controls().enableZoom = true;
            this.globe.controls().minDistance = 150;
            this.globe.controls().maxDistance = 600;

            this.setupTMZVisualization();
            this.setupRailNetwork();
        }

        setupThreeJSFallback() {
            const container = document.getElementById('globe-container');
            
            this.scene = new THREE.Scene();
            this.scene.background = new THREE.Color(0x000000);
            
            this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            this.camera.position.z = 300;
            
            this.renderer = new THREE.WebGLRenderer({ antialias: true });
            this.renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(this.renderer.domElement);
            
            this.createBlackEarth();
            this.addLighting();
            this.addTMZMarkers();
            this.addRailConnections();
            this.startAnimation();
        }

        createBlackEarth() {
            const geometry = new THREE.SphereGeometry(100, 64, 32);
            
            // Create black earth with blue continent lines
            const canvas = document.createElement('canvas');
            canvas.width = 2048;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            // Black base
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw continent outlines in blue
            this.drawContinentOutlines(ctx);
            
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.MeshPhongMaterial({
                map: texture,
                transparent: false
            });
            
            this.earth = new THREE.Mesh(geometry, material);
            this.scene.add(this.earth);
            
            this.addAtmosphereGlow();
        }

        drawContinentOutlines(ctx) {
            ctx.strokeStyle = '#00FFFF';
            ctx.lineWidth = 2;
            ctx.shadowColor = '#00FFFF';
            ctx.shadowBlur = 5;
            
            // North America
            ctx.beginPath();
            ctx.moveTo(300, 400);
            ctx.quadraticCurveTo(400, 350, 500, 400);
            ctx.quadraticCurveTo(550, 450, 600, 400);
            ctx.lineTo(600, 500);
            ctx.quadraticCurveTo(500, 550, 400, 500);
            ctx.quadraticCurveTo(350, 480, 300, 500);
            ctx.closePath();
            ctx.stroke();
            
            // Europe/Africa
            ctx.beginPath();
            ctx.moveTo(950, 350);
            ctx.quadraticCurveTo(1100, 300, 1200, 350);
            ctx.lineTo(1250, 600);
            ctx.quadraticCurveTo(1200, 650, 1100, 600);
            ctx.quadraticCurveTo(1000, 620, 950, 600);
            ctx.closePath();
            ctx.stroke();
            
            // Asia
            ctx.beginPath();
            ctx.moveTo(1300, 300);
            ctx.quadraticCurveTo(1500, 250, 1700, 300);
            ctx.quadraticCurveTo(1750, 400, 1700, 500);
            ctx.quadraticCurveTo(1600, 520, 1500, 500);
            ctx.quadraticCurveTo(1350, 480, 1300, 450);
            ctx.closePath();
            ctx.stroke();
            
            // Australia
            ctx.beginPath();
            ctx.moveTo(1600, 700);
            ctx.quadraticCurveTo(1700, 680, 1800, 700);
            ctx.quadraticCurveTo(1820, 750, 1800, 800);
            ctx.quadraticCurveTo(1700, 820, 1600, 800);
            ctx.closePath();
            ctx.stroke();
            
            // Draw TMZ markers
            this.tmzData.forEach(tmz => {
                const x = ((tmz.lng + 180) / 360) * 2048;
                const y = ((90 - tmz.lat) / 180) * 1024;
                
                // TMZ marker
                ctx.fillStyle = tmz.tier === 'ALPHA' ? '#FFD700' : '#00FFFF';
                ctx.shadowColor = ctx.fillStyle;
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(x, y, tmz.tier === 'ALPHA' ? 8 : 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // TMZ boundary
                ctx.strokeStyle = tmz.tier === 'ALPHA' ? '#FFD700' : '#25E1ED';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.arc(x, y, tmz.tier === 'ALPHA' ? 40 : 30, 0, 2 * Math.PI);
                ctx.stroke();
            });
        }

        addAtmosphereGlow() {
            const glowGeometry = new THREE.SphereGeometry(105, 32, 16);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: 0x00FFFF,
                transparent: true,
                opacity: 0.1,
                side: THREE.BackSide
            });
            
            this.atmosphere = new THREE.Mesh(glowGeometry, glowMaterial);
            this.scene.add(this.atmosphere);
        }

        addLighting() {
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            this.scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0x00FFFF, 0.4);
            directionalLight.position.set(1, 1, 1);
            this.scene.add(directionalLight);
        }

        addTMZMarkers() {
            this.tmzMarkers = [];
            
            this.tmzData.forEach(tmz => {
                const position = this.latLonToVector3(tmz.lat, tmz.lng, 102);
                
                const markerGeometry = new THREE.CylinderGeometry(1, 2, 6, 8);
                const markerMaterial = new THREE.MeshBasicMaterial({
                    color: tmz.tier === 'ALPHA' ? 0xFFD700 : 0x00FFFF,
                    transparent: true,
                    opacity: 0.9
                });
                
                const marker = new THREE.Mesh(markerGeometry, markerMaterial);
                marker.position.copy(position);
                marker.lookAt(new THREE.Vector3(0, 0, 0));
                marker.userData = tmz;
                
                this.scene.add(marker);
                this.tmzMarkers.push(marker);
            });
            
            // Add click detection
            this.setupClickDetection();
        }

        setupClickDetection() {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            const canvas = this.renderer.domElement;
            
            canvas.addEventListener('click', (event) => {
                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                
                raycaster.setFromCamera(mouse, this.camera);
                const intersects = raycaster.intersectObjects(this.tmzMarkers);
                
                if (intersects.length > 0) {
                    this.showTMZPopup(intersects[0].object.userData, event.clientX, event.clientY);
                } else {
                    this.hideTMZPopup();
                }
            });
        }

        addRailConnections() {
            this.railConnections.forEach(connection => {
                const tmz1 = this.tmzData.find(t => t.name === connection[0]);
                const tmz2 = this.tmzData.find(t => t.name === connection[1]);
                
                if (tmz1 && tmz2) {
                    this.createRailConnection(tmz1, tmz2);
                }
            });
        }

        createRailConnection(tmz1, tmz2) {
            const start = this.latLonToVector3(tmz1.lat, tmz1.lng, 101);
            const end = this.latLonToVector3(tmz2.lat, tmz2.lng, 101);
            
            const mid = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
            mid.normalize().multiplyScalar(115);
            
            const curve = new THREE.QuadraticBezierCurve3(start, mid, end);
            const points = curve.getPoints(50);
            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            
            const material = new THREE.LineBasicMaterial({
                color: 0x00FFFF,
                transparent: true,
                opacity: 0.7
            });
            
            const line = new THREE.Line(geometry, material);
            this.scene.add(line);
        }

        setupTMZVisualization() {
            if (!this.globe) return;
            
            // TMZ points with better visibility
            this.globe
                .pointsData(this.tmzData)
                .pointColor(d => d.tier === 'ALPHA' ? '#FFD700' : '#00FFFF')
                .pointAltitude(0.02)
                .pointRadius(d => d.tier === 'ALPHA' ? 0.4 : 0.3)
                .pointLabel(d => this.createTMZTooltip(d))
                .onPointClick(this.handleTMZClick.bind(this));
        }

        setupRailNetwork() {
            if (!this.globe) return;
            
            const arcs = this.railConnections.map(connection => {
                const tmz1 = this.tmzData.find(t => t.name === connection[0]);
                const tmz2 = this.tmzData.find(t => t.name === connection[1]);
                
                return {
                    startLat: tmz1.lat,
                    startLng: tmz1.lng,
                    endLat: tmz2.lat,
                    endLng: tmz2.lng,
                    color: '#00FFFF'
                };
            });

            this.globe
                .arcsData(arcs)
                .arcColor('color')
                .arcDashLength(0.4)
                .arcDashGap(0.2)
                .arcDashAnimateTime(2000)
                .arcStroke(1)
                .arcsTransitionDuration(1000);
        }

        createTMZTooltip(tmz) {
            return `
                <div style="
                    background: rgba(0, 0, 0, 0.9);
                    border: 1px solid #00FFFF;
                    border-radius: 6px;
                    padding: 10px;
                    color: white;
                    font-family: 'Orbitron', monospace;
                    font-size: 0.8rem;
                    max-width: 200px;
                ">
                    <h4 style="color: #25E1ED; margin-bottom: 5px;">${tmz.name}</h4>
                    <p style="margin-bottom: 5px; color: #ccc;">${tmz.description}</p>
                    <div style="font-size: 0.7rem;">
                        <div><strong>Pop:</strong> ${tmz.population}</div>
                        <div><strong>Status:</strong> ${tmz.status}</div>
                        <div><strong>Tier:</strong> ${tmz.tier}</div>
                    </div>
                </div>
            `;
        }

        handleTMZClick(tmz, event) {
            this.showTMZPopup(tmz, event.pageX, event.pageY);
        }

        showTMZPopup(tmz, x, y) {
            // Clear any existing timeout
            if (this.popupTimeout) {
                clearTimeout(this.popupTimeout);
            }
            
            // Hide current popup
            this.hideTMZPopup();
            
            const popup = document.getElementById('tmz-popup');
            
            // Populate data
            document.getElementById('popup-title').textContent = tmz.name;
            document.getElementById('popup-description').textContent = tmz.description;
            document.getElementById('popup-population').textContent = tmz.population;
            document.getElementById('popup-status').textContent = tmz.status;
            document.getElementById('popup-tier').textContent = tmz.tier;
            document.getElementById('popup-offset').textContent = tmz.offset;
            
            // Position popup
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            
            // Show popup
            popup.classList.add('visible');
            this.currentPopup = popup;
            
            // Auto-hide after 5 seconds
            this.popupTimeout = setTimeout(() => {
                this.hideTMZPopup();
            }, 5000);
        }

        hideTMZPopup() {
            if (this.currentPopup) {
                this.currentPopup.classList.remove('visible');
                this.currentPopup = null;
            }
            if (this.popupTimeout) {
                clearTimeout(this.popupTimeout);
                this.popupTimeout = null;
            }
        }

        setupControls() {
            const canvas = this.globe ? 
                document.querySelector('#globe-container canvas') : 
                this.renderer.domElement;
            
            if (!canvas) return;

            // Touch controls
            let isRotating = false;
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isRotating = true;
                if (this.globe) {
                    this.globe.controls().autoRotate = false;
                }
            });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                isRotating = false;
                setTimeout(() => {
                    if (this.globe && !isRotating) {
                        this.globe.controls().autoRotate = true;
                    }
                }, 2000);
            });

            // Hide popup when touching globe
            canvas.addEventListener('touchstart', () => {
                this.hideTMZPopup();
            });

            window.addEventListener('resize', () => {
                if (this.globe) {
                    this.globe
                        .width(window.innerWidth)
                        .height(window.innerHeight);
                } else if (this.renderer) {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                }
            });
        }

        startAnimation() {
            if (!this.renderer) return;
            
            const animate = () => {
                requestAnimationFrame(animate);
                
                if (this.earth) {
                    this.earth.rotation.y += 0.003;
                }
                
                this.renderer.render(this.scene, this.camera);
            };
            
            animate();
        }

        startTimeUpdates() {
            const updateTime = () => {
                const now = new Date();
                const utcTime = now.toUTCString().split(' ')[4];
                document.getElementById('utc-time').textContent = utcTime;
            };

            updateTime();
            setInterval(updateTime, 1000);
        }

        updateStats() {
            document.getElementById('tmz-count').textContent = this.tmzData.length;
            document.getElementById('rail-connections').textContent = this.railConnections.length;
        }

        latLonToVector3(lat, lon, radius) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lon + 180) * (Math.PI / 180);
            
            return new THREE.Vector3(
                -radius * Math.sin(phi) * Math.cos(theta),
                radius * Math.cos(phi),
                radius * Math.sin(phi) * Math.sin(theta)
            );
        }

        generateBlackEarthTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 2048;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            this.drawContinentOutlines(ctx);
            
            return canvas.toDataURL();
        }

        generateStarField() {
            const canvas = document.createElement('canvas');
            canvas.width = 2048;
            canvas.height = 1024;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            for (let i = 0; i < 800; i++) {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height;
                const size = Math.random() * 1.5 + 0.5;
                const opacity = Math.random() * 0.8 + 0.2;
                
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, 2 * Math.PI);
                ctx.fill();
            }
            
            return canvas.toDataURL();
        }

        hideLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 800);
        }

        initFallback() {
            const loadingScreen = document.getElementById('loading-screen');
            loadingScreen.innerHTML = `
                <div class="error-screen">
                    <h2 style="color: #ff4444 !important; margin-bottom: 1rem !important;">CHRONOS SYSTEM ERROR</h2>
                    <p style="color: #ffaa44 !important; margin-bottom: 1rem !important;">Failed to initialize 3D Earth system</p>
                    <p style="color: #ffffff !important; font-size: 0.9rem !important;">Please check your connection and refresh</p>
                    <button class="retry-btn" onclick="location.reload()">RETRY INITIALIZATION</button>
                </div>
            `;
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        new CHRONOSEarth();
    });

    // Prevent zoom on mobile
    document.addEventListener('touchstart', function(event) {
        if (event.touches.length > 1) {
            event.preventDefault();
        }
    });

    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
</script>
```

</body>
</html>
